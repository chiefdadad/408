# 外部排序

1. ### 基本原理：

   外部排序是基于**归并排序**进行的，每次都将需要归并的存储块放入内存中，并且在内存中申请了3个大小与这个块相等的存储空间用于归并排序（其中两个暂存两个需要归并的块，另外一个为读出磁盘的块，用于存储归并之后的块。

   ![image-20250617220221829](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20250617220221829.png)

   

2. ### 时间开销分析：

   ![image-20250617220527601](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20250617220527601.png)

   

3. ### 优化外部排序（减少归并趟数 = 减少读写外存的时间）：

   使用多路归并，在内存申请多个缓冲区进行归并操作。（如4路归并只需要2趟归并）

   ![image-20250617220834954](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20250617220834954.png)

   **优化思路：**

   - 增加归并路数k，进行多路归并（k不能无限增大，k太大会导致输入**缓冲区增加**，并且每次从k个归并段中选一个元素要**进行k-1次关键字对比**）；
   - 减少初始归并段的数量r（若有N个记录，内存工作区可以容纳L个记录，那么初始归并段的数量**r = N/L**)。



**注意：**k路平衡归并

![image-20250617221615337](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20250617221615337.png)



# 败者树

​		由于使用k路归并排序中，选出一个最小的元素需要对比关键字k-1次，这样导致内部归并所需要的时间增加，而败者树能够解决这个问题。



1. ### 败者树的定义：

   败者树可以视为一个**完全二叉树**（但是根节点上**多了一个“胜者”**），k个叶节点分别对应了**k个归并段中参加比较的元素**，非叶子结点用来记忆左右子树的**“失败者”**，每一轮的胜者继续向上进行比较，直到找到根节点。

![image-20250617234020816](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20250617234020816.png)



# 置换-选择排序

​		由于使用之前的办法只能构造一个**n/l的初始归并段**，这样进行外部排序效率不高，因此可以引入置换-选择排序来**构造一个更长的初始归并段**。

![image-20250617235403214](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20250617235403214.png)

![image-20250617235444132](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20250617235444132.png)



# 最佳归并树

1. ### 归并树的性质（磁盘I/O次数 = 归并树的WPL * 2）：

   ![image-20250618001552605](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20250618001552605.png)

   

2. ### 想要使I/O次数更少，就需要归并树WPL最小——哈夫曼树：

   ![image-20250618001951748](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20250618001951748.png)

   

3. ### 当去掉几个归并段时:

   对于k叉归并，当初始归并段的数量无法构成严格的k叉归并树（假如让一个原本可以构成的去掉一个归并段），则需要补充**几个长度为0的虚段**，然后继续进行k叉哈夫曼树的构造：

   

   ### 到底需要补充几个虚段？

   ![image-20250618002726711](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20250618002726711.png)